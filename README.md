# WebRTC Видеоконференция на mediasoup

Это приложение для видеоконференций, построенное на технологии WebRTC с использованием фреймворка mediasoup. Приложение позволяет пользователям включать веб-камеру и видеть других участников в реальном времени.

## Особенности

- Передача видеопотоков в реальном времени
- Выбор камеры из доступных устройств
- Архитектура SFU (Selective Forwarding Unit) для эффективной маршрутизации медиапотоков
- Индикаторы статуса соединения
- Адаптивная сетка для отображения видеопотоков
- Два режима отображения для обхода ограничений безопасности браузеров

## Инструкция по развертыванию

### 1. Предварительные требования

- Node.js 18+ и npm
- Доступ к серверу с открытыми портами
- Доменное имя (рекомендуется для полноценной работы WebRTC)
- SSL-сертификат (обязательно для WebRTC в продакшн)

### 2. Клонирование репозитория

```bash
git clone <url-репозитория>
cd webrtc-conference
```

### 3. Установка зависимостей

```bash
npm install
```

### 4. Настройка сервера

#### Настройка портов mediasoup

Отредактируйте файл `server/mediasoup.ts` и установите диапазон портов RTC в соответствии с вашими потребностями:

```typescript
const config = {
  rtcMinPort: 40000, // Минимальный порт для WebRTC
  rtcMaxPort: 49999, // Максимальный порт для WebRTC
  // ... другие настройки
};
```

#### Настройка CORS

В файле `server/index.ts` настройте CORS в соответствии с вашим доменом:

```typescript
app.use(cors({
  origin: 'https://ваш-домен.com', // Замените на ваш домен
  credentials: true,
}));
```

### 5. Настройка SSL (для продакшн)

Для работы в продакшне WebRTC требует HTTPS. Настройте SSL, используя один из методов:

#### С использованием reverse proxy (рекомендуется)

Используйте Nginx или Apache как reverse proxy для обеспечения HTTPS:

**Пример конфигурации Nginx:**

```nginx
server {
    listen 443 ssl;
    server_name ваш-домен.com;

    ssl_certificate /путь/к/сертификату.crt;
    ssl_certificate_key /путь/к/ключу.key;

    location / {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

#### Напрямую в Express (альтернативный вариант)

Для напрямую HTTPS в Express добавьте в `server/index.ts`:

```typescript
import https from 'https';
import fs from 'fs';

const options = {
  key: fs.readFileSync('/путь/к/ключу.key'),
  cert: fs.readFileSync('/путь/к/сертификату.crt')
};

const server = https.createServer(options, app);
// ... остальной код
```

### 6. Настройка сетевых параметров mediasoup

В продакшн-окружении нужно настроить IP-адреса для mediasoup в файле `server/mediasoup.ts`:

```typescript
const transportOptions = {
  listenIps: [
    {
      ip: '0.0.0.0', // или конкретный IP сервера
      announcedIp: 'публичный-ip-сервера', // Заменить на реальный публичный IP
    }
  ],
  // ... другие настройки
};
```

### 7. Запуск приложения

#### Режим разработки

```bash
npm run dev
```

#### Режим продакшн

```bash
npm run build
npm start
```

### 8. Настройка брандмауэра

Откройте следующие порты на вашем сервере:

- **5000**: HTTP/HTTPS сервер (или какой порт вы используете)
- **40000-49999**: Диапазон портов для WebRTC (или то, что вы настроили в `server/mediasoup.ts`)

### 9. Проверка работоспособности

После развертывания:

1. Откройте ваш сайт в браузере по HTTPS
2. Дайте разрешение на использование камеры
3. Откройте сайт в другом браузере или устройстве для проверки подключения

## Решение проблем безопасности браузера

Если вы сталкиваетесь с ограничениями безопасности браузера:

1. **Убедитесь, что сайт работает через HTTPS**
   - WebRTC требует безопасное соединение для работы в современных браузерах

2. **Проверьте заголовки CORS**
   - Необходимо, чтобы сервер отправлял правильные CORS-заголовки

3. **Не используйте iframe для встраивания видеоконференции**
   - Iframe создает дополнительные ограничения безопасности для WebRTC
   - Если необходимо использовать iframe, добавьте атрибуты разрешений:
     ```html
     <iframe allow="camera; microphone; display-capture" src="..."></iframe>
     ```

4. **Проверьте политики CSP**
   - Content Security Policy может блокировать WebRTC соединения
   - Добавьте необходимые разрешения в CSP заголовки

## Требования к серверу

- **CPU**: минимум 2 ядра (рекомендуется 4+ для большего числа участников)
- **RAM**: минимум 2 GB (рекомендуется 4+ GB)
- **Сеть**: стабильное соединение, минимум 10 Mbps
- **Пропускная способность**: зависит от количества участников и качества видео

## Масштабирование

Для обслуживания большего количества одновременных конференций:

1. Увеличение ресурсов сервера
2. Использование нескольких mediasoup воркеров
3. Горизонтальное масштабирование с балансировкой нагрузки

## Лицензия

[MIT](LICENSE)